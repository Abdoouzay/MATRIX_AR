from telethon import Button, events

from Jmthon.razan.resources.mybot import *

from ..Config import Config
import asyncio
import html
import os
import re
from math import ceil
import time
import datetime
from telethon import Button, custom, events, functions
from telethon.tl.functions.users import GetFullUserRequest
from userbot import CMD_HELP, CMD_LIST
from userbot import jmthon
import json
import math
import os
import random
import re
import time
from uuid import uuid4

from telethon import Button, types
from telethon.errors import QueryIdInvalidError
from telethon.events import CallbackQuery, InlineQuery
from youtubesearchpython import VideosSearch

from userbot import jmthon

from ..Config import Config
from ..helpers.functions import rand_key
from ..helpers.functions.utube import (
    download_button,
    get_yt_video_id,
    get_ytthumb,
    result_formatter,
    ytsearch_data,
)
from ..plugins import mention
from ..sql_helper.globals import gvarstatus
from . import CMD_INFO, GRP_INFO, PLG_INFO, check_owner
from .logger import logging

CUSTOM_HELP_EMOJI = os.environ.get("CUSTOM_HELP_EMOJI", "")
HELP_ROWS = int(os.environ.get("HELP_ROWS", 5))
HELP_COLOUMNS = int(os.environ.get("HELP_COLOUMNS", 3))
LOGS = logging.getLogger(__name__)
BTN_URL_REGEX = re.compile(r"(\[([^\[]+?)\]\<buttonurl:(?:/{0,2})(.+?)(:same)?\>)")
CATLOGO = "https://telegra.ph/file/88f00e9c84c0a01207adb.jpg"
tr = Config.COMMAND_HAND_LER
def getkey(val):
    for key, value in GRP_INFO.items():
        for plugin in value:
            if val == plugin:
                return key
    return None

def ibuild_keyboard(buttons):
    keyb = []
    for btn in buttons:
        if btn[2] and keyb:
            keyb[-1].append(Button.url(btn[0], btn[1]))
        else:
            keyb.append([Button.url(btn[0], btn[1])])
    return keyb

@jmthon.tgbot.on(InlineQuery)
async def inline_handler(event):  
    builder = event.builder
    result = None
    query = event.text
    string = query.lower()
    query.split(" ", 2)
    str_y = query.split(" ", 1)
    string.split()
    query_user_id = event.query.user_id
    if query_user_id == Config.OWNER_ID or query_user_id in Config.SUDO_USERS:
        hmm = re.compile("ŸáŸÖÿ≥ÿ© (.*) (.*)")
        match = re.findall(hmm, query)
        if query.startswith("**JMTHON"):
            buttons = [
                (
                    Button.inline("ÿßŸÑÿ≥Ÿàÿ±ÿ≥", data="stats"),
                    Button.url("ch", "t.me/jmthon"),
                )
            ]
            ALIVE_PIC = gvarstatus("ALIVE_PIC")
            IALIVE_PIC = gvarstatus("IALIVE_PIC")
            if IALIVE_PIC:
                CAT = [x for x in IALIVE_PIC.split()]
                PIC = list(CAT)
                I_IMG = random.choice(PIC)
            if not IALIVE_PIC and ALIVE_PIC:
                CAT = [x for x in ALIVE_PIC.split()]
                PIC = list(CAT)
                I_IMG = random.choice(PIC)
            elif not IALIVE_PIC:
                I_IMG = None
            if I_IMG and I_IMG.endswith((".jpg", ".png")):
                result = builder.photo(
                    I_IMG,
                    text=query,
                    buttons=buttons,
                )
            elif I_IMG:
                result = builder.document(
                    I_IMG,
                    title="Alive cat",
                    text=query,
                    buttons=buttons,
                )
            else:
                result = builder.article(
                    title="Alive cat",
                    text=query,
                    buttons=buttons,
                )
            await event.answer([result] if result else None)
        elif query.startswith("Inline buttons"):
            markdown_note = query[14:]
            prev = 0
            note_data = ""
            buttons = []
            for match in BTN_URL_REGEX.finditer(markdown_note):
                n_escapes = 0
                to_check = match.start(1) - 1
                while to_check > 0 and markdown_note[to_check] == "\\":
                    n_escapes += 1
                    to_check -= 1
                if n_escapes % 2 == 0:
                    buttons.append(
                        (match.group(2), match.group(3), bool(match.group(4)))
                    )
                    note_data += markdown_note[prev : match.start(1)]
                    prev = match.end(1)
                elif n_escapes % 2 == 1:
                    note_data += markdown_note[prev:to_check]
                    prev = match.start(1) - 1
                else:
                    break
            else:
                note_data += markdown_note[prev:]
            message_text = note_data.strip()
            tl_ib_buttons = ibuild_keyboard(buttons)
            result = builder.article(
                title="Inline creator",
                text=message_text,
                buttons=tl_ib_buttons,
                link_preview=False,
            )
            await event.answer([result] if result else None)
        elif match:
            query = query[7:]
            user, txct = query.split(" ", 1)
            builder = event.builder
            secret = os.path.join("./userbot", "secrets.txt")
            try:
                jsondata = json.load(open(secret))
            except Exception:
                jsondata = False
            try:
                # if u is user id
                u = int(user)
                try:
                    u = await event.client.get_entity(u)
                    if u.username:
                        sandy = f"@{u.username}"
                    else:
                        sandy = f"[{u.first_name}](tg://user?id={u.id})"
                except ValueError:
                    sandy = f"[user](tg://user?id={u})"
            except ValueError:
                try:
                    u = await event.client.get_entity(user)
                except ValueError:
                    return
                if u.username:
                    sandy = f"@{u.username}"
                else:
                    sandy = f"[{u.first_name}](tg://user?id={u.id})"
                u = int(u.id)
            except Exception:
                return
            timestamp = int(time.time() * 2)
            newsecret = {str(timestamp): {"userid": u, "text": txct}}

            buttons = [Button.inline("ÿπÿ±ÿ∂ ÿßŸÑŸáŸÖÿ≥ÿ© ", data=f"secret_{timestamp}")]
            result = builder.article(
                title="ŸáŸÖÿ≥ÿ© ÿ≥ÿ±Ÿäÿ©",
                text=f" ÿßŸÑŸáŸÖÿ≥ÿ© ÿßŸÑÿ≥ÿ±Ÿäÿ© ŸÑŸÄ {sandy} ŸáŸà ŸÅŸÇÿ∑ ŸÖŸÜ ŸäŸÖŸÉŸÜŸá ÿπÿ±ÿ∂Ÿáÿß.",
                buttons=buttons,
            )
            await event.answer([result] if result else None)
            if jsondata:
                jsondata.update(newsecret)
                json.dump(jsondata, open(secret, "w"))
            else:
                json.dump(newsecret, open(secret, "w"))
        elif str_y[0].lower() == "ytdl" and len(str_y) == 2:
            link = get_yt_video_id(str_y[1].strip())
            found_ = True
            if link is None:
                search = VideosSearch(str_y[1].strip(), limit=15)
                resp = (search.result()).get("result")
                if len(resp) == 0:
                    found_ = False
                else:
                    outdata = await result_formatter(resp)
                    key_ = rand_key()
                    ytsearch_data.store_(key_, outdata)
                    buttons = [
                        Button.inline(
                            f"1 / {len(outdata)}",
                            data=f"ytdl_next_{key_}_1",
                        ),
                        Button.inline(
                            "üìú  List all",
                            data=f"ytdl_listall_{key_}_1",
                        ),
                        Button.inline(
                            "‚¨áÔ∏è  Download",
                            data=f'ytdl_download_{outdata[1]["video_id"]}_0',
                        ),
                    ]
                    caption = outdata[1]["message"]
                    photo = await get_ytthumb(outdata[1]["video_id"])
            else:
                caption, buttons = await download_button(link, body=True)
                photo = await get_ytthumb(link)
            if found_:
                markup = event.client.build_reply_markup(buttons)
                photo = types.InputWebDocument(
                    url=photo, size=0, mime_type="image/jpeg", attributes=[]
                )
                text, msg_entities = await event.client._parse_message_text(
                    caption, "html"
                )
                result = types.InputBotInlineResult(
                    id=str(uuid4()),
                    type="photo",
                    title=link,
                    description="‚¨áÔ∏è Click to Download",
                    thumb=photo,
                    content=photo,
                    send_message=types.InputBotInlineMessageMediaAuto(
                        reply_markup=markup, message=text, entities=msg_entities
                    ),
                )
            else:
                result = builder.article(
                    title="Not Found",
                    text=f"No Results found for `{str_y[1]}`",
                    description="INVALID",
                )
            try:
                await event.answer([result] if result else None)
            except QueryIdInvalidError:
                await event.answer(
                    [
                        builder.article(
                            title="Not Found",
                            text=f"No Results found for `{str_y[1]}`",
                            description="INVALID",
                        )
                    ]
                )
        elif string == "pmpermit":
            buttons = [
                Button.inline(text="ÿßÿ∂Ÿáÿßÿ± ÿßŸÑÿÆŸäÿßÿ±ÿßÿ™", data="show_pmpermit_options"),
            ]
            PM_PIC = gvarstatus("pmpermit_pic")
            if PM_PIC:
                CAT = [x for x in PM_PIC.split()]
                PIC = list(CAT)
                CAT_IMG = random.choice(PIC)
            else:
                CAT_IMG = None
            query = gvarstatus("pmpermit_text")
            if CAT_IMG and CAT_IMG.endswith((".jpg", ".jpeg", ".png")):
                result = builder.photo(
                    CAT_IMG,
                    # title="Alive cat",
                    text=query,
                    buttons=buttons,
                )
            elif CAT_IMG:
                result = builder.document(
                    CAT_IMG,
                    title="Alive cat",
                    text=query,
                    buttons=buttons,
                )
            else:
                result = builder.article(
                    title="Alive cat",
                    text=query,
                    buttons=buttons,
                )
            await event.answer([result] if result else None)
    else:
        buttons = [
            (
                Button.url("Source code", "https://t.me/jmthon"),
                Button.url(
                    "Deploy",
                    "https://dashboard.heroku.com/new?button-url=https%3A%2F%2Fgithub.com%2FMr-confused%2Fcatpack&template=https%3A%2F%2Fgithub.com%2FMr-confused%2Fcatpack",
                ),
            )
        ]
        markup = event.client.build_reply_markup(buttons)
        photo = types.InputWebDocument(
            url=CATLOGO, size=0, mime_type="image/jpeg", attributes=[]
        )
        text, msg_entities = await event.client._parse_message_text(
            "jmthon.", "md"
        )
        result = types.InputBotInlineResult(
            id=str(uuid4()),
            type="photo",
            title="jmthon",
            description="ŸÜÿµÿ® ŸÑŸÜŸÅÿ≥ŸÉ",
            url="https://dashboard.heroku.com/new?template=https://github.com/JMTHON-AR/JMTHON-PACK",
            thumb=photo,
            content=photo,
            send_message=types.InputBotInlineMessageMediaAuto(
                reply_markup=markup, message=text, entities=msg_entities
            ),
        )
        await event.answer([result] if result else None)
        
if Config.TG_BOT_USERNAME is not None and tgbot is not None:
    @tgbot.on(events.InlineQuery)  # pylint:disable=E0602
    async def inline_handler(event):
        builder = event.builder
        result = None
        query = event.text
        if event.query.user_id == bot.uid and query.startswith("**‚Ä¢   ùôÖùôàùôèùôÉùôäùôâ"):
            rev_text = query[::-1]
            buttons = paginate_help(0, CMD_LIST, "helpme")
            result = builder.article(
                "¬© ŸÖÿ≥ÿßÿπÿØÿ© ÿ¨ŸÖÿ´ŸàŸÜ",
                text="{}\n ÿßŸÑŸÖŸÑŸÅÿßÿ™ ÿßŸÑÿ≠ÿßŸÑŸäÿ© ŸÅŸä ÿ≥Ÿàÿ±ÿ≥ ÿ¨ŸÖÿ´ŸàŸÜ ÿßŸÑÿπÿ±ÿ®Ÿä: {}".format(query, len(CMD_LIST)),
                buttons=buttons,
                link_preview=False,
            )
        elif event.query.user_id == bot.uid and query == "stats":
            result = builder.article(
                title="ÿ®Ÿàÿ™",
                text=f"**- ÿ≠ÿßŸÑÿ© ÿ®Ÿàÿ™ ÿ¨ŸÖÿ´ŸàŸÜ ŸÑŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ [{DEFAULTUSER}](tg://user?id={myid})**\n\n- ÿßŸÑÿ®Ÿàÿ™ ŸäÿπŸÖŸÑ ÿ®ŸÜÿ¨ÿßÿ≠ Ÿäÿß ÿµÿßÿ≠\n\n@Jmthon ",
                buttons=[
                    [custom.Button.inline("ÿßŸÑÿ≠ÿßŸÑÿ©", data="statcheck")],
                    [Button.url("ÿ™ŸÜÿµŸäÿ® ÿ¨ŸÖÿ´ŸàŸÜ", "https://heroku.com/deploy?template=https://github.com/JMTHON-AR/Jmthon")],
                ],
            )
        elif event.query.user_id == bot.uid and query == "alive":
            ALIVE = ALV_TXT
            if ALIVE_PIC and ALIVE_PIC.endswith((".jpg", ".png")):
               result = builder.photo(
                 ALIVE_PIC,
                 text = ALIVE,
              
                 buttons = [
                   [
                     Button.url("ŸÇŸÜÿßÿ© ÿ¨ŸÖÿ´ŸàŸÜ", "https://t.me/Jmthon"),
                     Button.url("ŸÉÿ±Ÿàÿ® ÿ¨ŸÖÿ´ŸàŸÜ", "https://t.me/GroupJmthon")
                   ],
                   [
                     Button.inline("‚Ä¢ ÿ≠ŸàŸÑ ŸÖÿßŸÑŸÉŸä ‚Ä¢", data="master")
                   ],
                ],
              )
            else:
              result = builder.document(
                 text = ALIVE,
                 title = "Jmthon",
                 file = ALIVE_PIC,
                 buttons = [
                   [
                     Button.url("ŸÇŸÜÿßÿ© ÿ¨ŸÖÿ´ŸàŸÜ", "https://t.me/Jmthon"),
                     Button.url("ŸÉÿ±Ÿàÿ® ÿ¨ŸÖÿ´ŸàŸÜ", "https://t.me/GroupJmthon")
                   ],
                   [
                     Button.inline("‚Ä¢ ÿ≠ŸàŸÑ ŸÖÿßŸÑŸÉŸä ‚Ä¢", data="master")
                   ],
                ],
              )
                
        elif event.query.user_id == bot.uid and query.startswith("**ÿßÿ≠ŸÖ"):
            JMTHONBT = USER_BOT_NO_WARN.format(DEFAULTUSER, myid, MESAG)
            result = builder.photo(
                file=JMTHON_PIC,
                text=JMTHONBT,
                buttons=[
                    [
                        custom.Button.inline("‚Ä¢ ŸÑÿ∑ŸÑÿ® ÿ¥Ÿä ‚Ä¢", data="rzeq"),
                        custom.Button.inline("‚Ä¢ ŸÑŸÑÿ≥ÿ§ÿßŸÑ ‚Ä¢", data="jmk")
                    ],
                    [
                        custom.Button.inline("‚Ä¢ ŸÑŸÑÿØÿ±ÿØÿ¥ÿ© ‚Ä¢", data="chat"),
                        custom.Button.inline("‚Ä¢ ÿ¥Ÿä ÿßÿÆÿ± ‚Ä¢", data="elsi")],
                ],
            )
        elif event.query.user_id == bot.uid and query == "paste":
              ok = event.text.split("-")[1]
              link = "https://spaceb.in/" + ok
              raw = f"https://spaceb.in/api/v1/documents/{ok}/raw"
              result = builder.article(
                   title= "Paste",
                   text = "ŸÑÿµŸÇ ÿßŸÑŸÉŸàÿØ ŸÅŸä ÿßŸÑŸÖÿ≠ÿ±ÿ±",
                   buttons=[
            [
                Button.url("ÿßŸÑŸÉŸàÿØ ", url=link),
                Button.url("ÿßŸÑŸÜÿµÔ∏è", url=raw),
            ],
        ],
    )
        else:
            result = builder.article(
                "ÿ≥Ÿàÿ±ÿ≥ ÿ¨ŸÖÿ´ŸàŸÜ  - ÿßŸÑÿßŸÅÿ∂ŸÑ ŸÅŸä ÿßŸÑÿ¥ÿ±ŸÇ ÿßŸÑÿßŸàÿ≥ÿ∑",
                text="**ŸÖÿ±ÿ≠ÿ®ÿß ÿ®ŸÉ ŸÅŸä ÿ≥Ÿàÿ±ÿ≥ ÿ¨ŸÖÿ´ŸàŸÜ**\n\n ÿßÿ∂ÿ∫ÿ∑ ŸÅŸä ÿßŸÑÿßÿ≥ŸÅŸÑ ŸÑÿπÿ±ÿ∂ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÉÿ´ÿ±",
                buttons=[
                    [custom.Button.url("ÿßŸÑŸÖÿ∑Ÿàÿ±", "https://t.me/rr9r7")],
                    [
                        custom.Button.url(
                            "ÿßŸÑÿ≥Ÿàÿ±ÿ≥", "https://t.me/Jmthon"
                        ),
                        custom.Button.url(
                            "ÿ™ŸÜÿµŸäÿ® ",
                            "https://heroku.com/deploy?template=https://github.com/JMTHON-AR/Jmthon",
                             ),
                    ],
                    [
                        custom.Button.url(
                            "ŸÖÿ¨ŸÖŸàÿπÿ© ÿ¨ŸÖÿ´ŸàŸÜ", "https://t.me/GroupJMTHON"
                        )
                    ],
                ],
                link_preview=False,
            )
        await event.answer([result] if result else None)
    @tgbot.on(
        events.callbackquery.CallbackQuery(
            data=re.compile(rb"helpme_next\((.+?)\)")
        )
    )
    async def on_plug_in_callback_query_handler(event):
        if event.query.user_id == bot.uid:
            current_page_number = int(event.data_match.group(1).decode("UTF-8"))
            buttons = paginate_help(current_page_number + 1, CMD_LIST, "helpme")
            await event.edit(buttons=buttons)
        else:
            reply_jmthon_alert = (
                "ÿπÿ∞ÿ±ÿß ŸÑÿß ÿ™ÿ≥ÿ™ÿ∑Ÿäÿπ ÿßŸÑÿ∂ÿ∫ÿ∑ ŸáŸÜÿß Ÿáÿ∞ÿß ÿßŸÑÿÆŸäÿßÿ± ŸÑŸäÿ≥ ŸÑŸÉÿå ŸÜÿµÿ® ÿ¨ŸÖÿ´ŸàŸÜ ŸÑŸÜŸÅÿ≥ŸÉ"
            )
            await event.answer(reply_jmthon_alert, cache_time=0, alert=True)

    @tgbot.on(events.callbackquery.CallbackQuery(data=re.compile(b"reopen")))
    async def megic(event):
        if event.query.user_id == bot.uid:
            buttons = paginate_help(0, CMD_LIST, "helpme")
            await event.edit("‚ñæ‚àÆ ŸÅÿ™ÿ≠ ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ±ÿ¶Ÿäÿ≥ŸäŸäÿ© ŸÖÿ±Ÿá ÿßÿÆÿ±Ÿâ ", buttons=buttons)
        else:
            reply_jmthon_alert = "ÿπÿ∞ÿ±ÿß ŸÑÿß ÿ™ÿ≥ÿ™ÿ∑Ÿäÿπ ÿßŸÑÿ∂ÿ∫ÿ∑ ŸáŸÜÿß Ÿáÿ∞ÿß ÿßŸÑÿÆŸäÿßÿ± ŸÑŸäÿ≥ ŸÑŸÉÿå ŸÜÿµÿ® ÿ¨ŸÖÿ´ŸàŸÜ ŸÑŸÜŸÅÿ≥ŸÉ"
            await event.answer(reply_jmthon_alert, cache_time=0, alert=True)

    @tgbot.on(events.callbackquery.CallbackQuery(data=re.compile(b"rzeq")))
    async def on_pm_click(event):
        if event.query.user_id == bot.uid:
            reply_jmthon_alert = "ÿπÿ∞ÿ±ÿß Ÿáÿ∞ÿß ÿßŸÑÿÆŸäÿßÿ± ŸÑŸäÿ≥ ŸÑŸÉ"
            await event.answer(reply_jmthon_alert, cache_time=0, alert=True)
        else:
            await event.edit(
                f"- ÿ≠ÿ≥ŸÜÿß ÿßÿ∞ÿß ŸÉÿßŸÜ ŸÑÿØŸäŸÉ ÿ¥Ÿäÿ° ŸÖÿß ŸÑŸÄ {MYUSER} \n ÿπŸÑŸäŸÉ ÿßŸÑÿ£ŸÜÿ™ÿ∏ÿßÿ± ŸÑÿ£ŸÜ ŸÖÿßŸÑŸÉ ÿßŸÑÿ≠ÿ≥ÿßÿ® ŸÖÿ¥ÿ∫ŸàŸÑ ÿ≠ÿßŸÑŸäÿß\n ŸÑÿß ÿ™ÿ±ÿ≥ŸÑ ÿßŸä ÿ¥Ÿä ŸÅŸÇÿ∑ ÿßŸÜÿ™ÿ∏ÿ±."
            )
            tarzt = await event.client(GetFullUserRequest(event.query.user_id))
            first_name = html.escape(tarzt.user.first_name)
            jmthon = event.query.user_id
            if first_name is not None:
                first_name = first_name.replace("\u2060", "")
            rozsend = f"- ŸÖÿ±ÿ≠ÿ®ÿß {MYUSER}, [{first_name}](tg://user?id={jmthon}) Ÿäÿ±ŸäÿØ ÿ∑ŸÑÿ® ÿ¥Ÿäÿ° ŸÖÿß \n ÿ±ÿ®ŸÖÿß Ÿäÿ±ŸäÿØ ÿßŸÜ ŸäÿÆÿ®ÿ±ŸÉ ÿ¥Ÿäÿ° ÿ£ÿ∞Ÿáÿ® Ÿàÿ™ÿ£ŸÉÿØ"
            await tgbot.send_message(LOG_JMTHON, rozsend)
            
    @tgbot.on(events.callbackquery.CallbackQuery(data=re.compile(b"chat")))
    async def on_pm_click(event):
        event.query.user_id
        if event.query.user_id == bot.uid:
            reply_jmthon_alert = "ÿπÿ∞ÿ±ÿß Ÿáÿ∞ÿß ÿßŸÑÿÆŸäÿßÿ± ŸÑŸäÿ≥ ŸÑŸÉ"
            await event.answer(reply_jmthon_alert, cache_time=0, alert=True)
        else:
            await event.edit(
                f"**- ÿ™ÿ±ŸäÿØ ÿßŸÑÿØÿ±ÿØÿ¥ÿ© üí¨**\n ÿßŸÉŸäÿØ ÿ™ÿ≥ÿ™ÿ∑Ÿäÿπ ŸÑŸÉŸÜ ŸÖÿßŸÑŸÉ ÿßŸÑÿ≠ÿ≥ÿßÿ® ŸÖÿ¥ÿ∫ŸàŸÑ ÿßŸÑÿßŸÜ ÿßŸÑÿ±ÿ¨ÿßÿ° ÿßŸÜÿ™ÿ∏ÿßÿ± ŸàÿµŸàŸÑ ÿßŸÑŸÖÿßŸÑŸÉ ŸàÿßŸÜÿ™ÿ∏ÿßÿ± ÿ±ÿØŸá ŸÑÿß ÿ™ŸÉÿ±ÿ± ÿßŸÑÿ±ÿ≥ÿßÿ¶ŸÑ ÿ±ÿ¨ÿßÿ°ÿß  !"
            )
            tarzt = await event.client(GetFullUserRequest(event.query.user_id))
            jmthon = event.query.user_id
            first_name = html.escape(tarzt.user.first_name)
            if first_name is not None:
                first_name = first_name.replace("\u2060", "")
            rozsend = f"‚ñæ‚àÆ ŸÖÿ±ÿ≠ÿ®ŸÄÿß {NAMERZ}\n [{first_name}](tg://user?id={jmthon}) Ÿäÿ±ŸäÿØ ÿßŸÜ Ÿäÿ±ÿßÿ≥ŸÑŸÉ ŸàŸäÿ™ÿ≠ÿØÿ´ ŸÖÿπŸÉ **\n ÿ£ÿ∞ÿß ŸÖÿß ÿπŸÜÿØŸÉ ŸàÿßŸáÿ≥ ŸàŸÖŸÅÿπŸÑ ŸÖŸàÿØ ŸÑÿß ÿ™ÿ±ÿØ ŸÖŸÜŸà ÿ¨ÿßÿ®ÿ±ŸÉ -_-"
            await tgbot.send_message(LOG_JMTHON, rozsend)

    @tgbot.on(events.callbackquery.CallbackQuery(data=re.compile(b"jmk")))
    async def on_pm_click(event):
        if event.query.user_id == bot.uid:
            reply_jmthon_alert = "ÿπÿ∞ÿ±ÿß Ÿáÿ∞ÿß ÿßŸÑÿÆŸäÿßÿ± ŸÑŸäÿ≥ ŸÑŸÉ"
            await event.answer(reply_jmthon_alert, cache_time=0, alert=True)
        else:
            await event.edit(
                f"‚ñæ‚àÆ ŸÖÿß ÿßŸÑÿ∞Ÿä ÿ™ÿ±ŸäÿØ ÿßŸÜ ÿ™ÿ≥ÿ£ŸÑŸá ŸÑŸÄ {NAMERZ} ÿßÿ∞ŸÉÿ± ŸÖÿßÿ∞ÿß ÿ™ÿ±ŸäÿØ ŸÅŸä ÿ±ÿ≥ÿßŸÑÿ© Ÿàÿßÿ≠ÿØÿ© ŸÅŸÇÿ∑ ÿ±ÿ¨ÿßÿ°ÿß ÿßŸÑÿ±ÿ¨ÿßÿ° ÿßŸÜÿ™ÿ∏ÿßÿ± ÿ±ÿØ ÿßŸÑŸÖÿßŸÑŸÉ"
            )
            tarzt = await event.client(GetFullUserRequest(event.query.user_id))
            first_name = html.escape(tarzt.user.first_name)
            jmthon = event.query.user_id
            if first_name is not None:
                first_name = first_name.replace("\u2060", "")
            rozsend = f"- ŸÖÿ±ÿ≠ÿ®ÿß {MYUSER}, [{first_name}](tg://user?id={jmthon}) Ÿäÿ±ŸäÿØ ŸÖÿ≠ÿßÿØÿ´ÿ™ŸÉ\n ÿ±ÿ®ŸÖÿß Ÿäÿ±ŸäÿØ ÿßŸÜ ŸäÿÆÿ®ÿ±ŸÉ ÿ¥Ÿäÿ° ÿ£ÿ∞Ÿáÿ® Ÿàÿ™ÿ£ŸÉÿØ"
            await tgbot.send_message(LOG_JMTHON, rozsend)

    @tgbot.on(events.callbackquery.CallbackQuery(data=re.compile(b"elsi")))
    async def on_pm_click(event):
        if event.query.user_id == bot.uid:
            reply_jmthon_alert = "ŸÖÿßÿ∞ÿß ÿ™ŸÅÿπŸÑ Ÿáÿ∞ÿß ŸÑŸäÿ≥ ŸÑŸÉ  ÿü"
            await event.answer(reply_jmthon_alert, cache_time=0, alert=True)
        else:
            await event.edit(
                f"- ÿ≠ÿ≥ŸÜÿß ÿßÿ∞ÿß ŸÉÿßŸÜ ŸÑÿØŸäŸÉ ÿ¥Ÿäÿ° ŸÖÿß ŸÑŸÄ {MYUSER} \n ÿπŸÑŸäŸÉ ÿßŸÑÿ£ŸÜÿ™ÿ∏ÿßÿ± ŸÑÿ£ŸÜ ŸÖÿßŸÑŸÉ ÿßŸÑÿ≠ÿ≥ÿßÿ® ŸÖÿ¥ÿ∫ŸàŸÑ ÿ≠ÿßŸÑŸäÿß\n ŸÑÿß ÿ™ÿ±ÿ≥ŸÑ ÿßŸä ÿ¥Ÿä ŸÅŸÇÿ∑ ÿßŸÜÿ™ÿ∏ÿ±."
            )
            tarzt = await event.client(GetFullUserRequest(event.query.user_id))
            first_name = html.escape(tarzt.user.first_name)
            jmthon = event.query.user_id
            first_name = html.escape(tarzt.user.first_name)
            if first_name is not None:
                first_name = first_name.replace("\u2060", "")
            first_name = html.escape(tarzt.user.first_name)
            await tgbot.send_message(
                LOG_JMTHON,
                f"- ŸÖÿ±ÿ≠ÿ®ÿß {MYUSER}\n[{first_name}](tg://user?id={jmthon}) Ÿäÿ±ŸäÿØ ŸÖÿ≠ÿßÿØÿ´ÿ™ŸÉ\n ÿ±ÿ®ŸÖÿß Ÿäÿ±ŸäÿØ ÿßŸÜ ŸäÿÆÿ®ÿ±ŸÉ ÿ¥Ÿäÿ° ÿ£ÿ∞Ÿáÿ® Ÿàÿ™ÿ£ŸÉÿØ",
            )

    @tgbot.on(events.callbackquery.CallbackQuery(data=re.compile(b"close")))
    async def on_plug_in_callback_query_handler(event):
        if event.query.user_id == bot.uid:
            await event.edit(
                "ÿ™ŸÖ ÿ∫ŸÑŸÇ ÿßŸÑŸÇÿßÿ¶ŸÖÿ©", buttons=[Button.inline("‚Ä¢ ŸÅÿ™ÿ≠ ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ‚Ä¢", data="reopen")]
            )
        else:
            reply_jmthon_alert = "ÿπÿ∞ÿ±ÿß ŸÑÿß ÿ™ÿ≥ÿ™ÿ∑Ÿäÿπ ÿßŸÑÿ∂ÿ∫ÿ∑ ŸáŸÜÿß Ÿáÿ∞ÿß ÿßŸÑÿÆŸäÿßÿ± ŸÑŸäÿ≥ ŸÑŸÉÿå ŸÜÿµÿ® ÿ¨ŸÖÿ´ŸàŸÜ ŸÑŸÜŸÅÿ≥ŸÉ"
            await event.answer(reply_jmthon_alert, cache_time=0, alert=True)

    @tgbot.on(events.callbackquery.CallbackQuery(data=re.compile(b"statcheck")))
    async def rip(event):
        text = telestats
        await event.answer(text, alert=True)

    @tgbot.on(
        events.callbackquery.CallbackQuery(
            data=re.compile(rb"helpme_prev\((.+?)\)")
        )
    )
    async def on_plug_in_callback_query_handler(event):
        if event.query.user_id == bot.uid:
            current_page_number = int(event.data_match.group(1).decode("UTF-8"))
            buttons = paginate_help(
                current_page_number - 1, CMD_LIST, "helpme"
            )
            await event.edit(buttons=buttons)
        else:
            reply_jmthon_alert = "ÿπÿ∞ÿ±ÿß ŸÑÿß ÿ™ÿ≥ÿ™ÿ∑Ÿäÿπ ÿßŸÑÿ∂ÿ∫ÿ∑ ŸáŸÜÿß Ÿáÿ∞ÿß ÿßŸÑÿÆŸäÿßÿ± ŸÑŸäÿ≥ ŸÑŸÉ .  ŸÜÿµÿ® ÿ¨ŸÖÿ´ŸàŸÜ ŸÑŸÜŸÅÿ≥ŸÉ"
            await event.answer(reply_jmthon_alert, cache_time=0, alert=True)

    @tgbot.on(
        events.callbackquery.CallbackQuery(
            data=re.compile(b"us_plugin_(.*)")
        )
    )
    async def on_plug_in_callback_query_handler(event):
        if event.query.user_id == bot.uid:
            plugin_name = event.data_match.group(1).decode("UTF-8")
            help_string = ""
            help_string += f"‚Ä¢ ÿßŸÑÿ£ŸàÿßŸÖÿ± ÿßŸÑŸÖÿ™ÿßÿ≠ÿ© ŸÅŸä {plugin_name} - \n"
            try:
                if plugin_name in CMD_HELP:
                    for i in CMD_HELP[plugin_name]:
                        help_string += i
                    help_string += "\n"
                else:
                    for i in CMD_LIST[plugin_name]:
                        help_string += i
                        help_string += "\n"
            except BaseException:
                pass
            if help_string == "":
                reply_jmthon_alert = "{} ŸÑŸäÿ≥ ŸÑŸá ŸÖÿπŸÑŸàŸÖÿßÿ™ ŸÉÿ´Ÿäÿ±ÿ©.\n ÿ£ÿ±ÿ≥ŸÑ .ŸÖÿ≥ÿßÿπÿØÿ© {}".format(
                    plugin_name, plugin_name
                )
            else:
                reply_jmthon_alert = help_string
            reply_jmthon_alert += "\n ÿßÿ±ÿ≥ŸÑ .ÿßŸÜŸÑŸàÿØ {} ŸÑÿ≠ÿ∞ŸÅ Ÿáÿ∞ÿß ÿßŸÑŸÖŸÑŸÅ\n\
                ŸÅÿ±ŸäŸÇ ÿ¨ÿ´ŸÖŸàŸÜ‚Ñ¢".format(
                plugin_name
            )
            if len(help_string) >= 140:
                oops = "ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿßŸàÿßŸÖÿ± ŸÉÿ®Ÿäÿ±ÿ© ÿ¨ÿØÿß ÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿßŸÑÿ±ÿ≥ÿßÿ¶ŸÑ ÿßŸÑŸÖÿ≠ŸÅŸàÿ∏ÿ© ŸÑÿπÿ±ÿ∂Ÿáÿß ŸÑŸÉ"
                await event.answer(oops, cache_time=0, alert=True)
                help_string += "\n\n- ÿ≥Ÿäÿ™ŸÖ ÿ≠ÿ∞ŸÅ Ÿáÿ∞Ÿá ÿßŸÑÿ±ÿ≥ÿßŸÑÿ© ÿ™ŸÑŸÇÿßÿ¶Ÿäÿß ÿ®ÿπÿØ ÿØŸÇŸäŸÇÿ™ŸäŸÜ"
                if bot is not None and event.query.user_id == bot.uid:
                    jmthon = await bot.send_message("me", help_string)
                    await asyncio.sleep(120)
                    await jmthon.delete()
            else:
                await event.answer(reply_jmthon_alert, cache_time=0, alert=True)
        else:
            reply_jmthon_alert = "ŸÇŸÖ ÿ®ÿ™ŸÜÿµŸäÿ® ÿ®Ÿàÿ™ ÿ¨ŸÖÿ´ŸàŸÜ ÿ®ŸÜŸÅÿ≥ŸÉ"
            await event.answer(reply_jmthon_alert, cache_time=0, alert=True)


def paginate_help(page_number, loaded_plugins, prefix):
    number_of_rows = HELP_ROWS
    number_of_cols = HELP_COLOUMNS
    tele = CUSTOM_HELP_EMOJI
    helpable_plugins = []
    for p in loaded_plugins:
        if not p.startswith("_"):
            helpable_plugins.append(p)
    helpable_plugins = sorted(helpable_plugins)
    modules = [
        custom.Button.inline(
            "{} {}".format(tele, x), data="us_plugin_{}".format(x)
        )
        for x in helpable_plugins
    ]
    pairs = list(zip(modules[::number_of_cols], modules[1::number_of_cols]))
    if len(modules) % number_of_cols == 1:
        pairs.append((modules[-1],))
    max_num_pages = ceil(len(pairs) / number_of_rows)
    modulo_page = page_number % max_num_pages
    if len(pairs) > number_of_rows:
        pairs = pairs[
            modulo_page * number_of_rows : number_of_rows * (modulo_page + 1)
        ] + [
            (
                custom.Button.inline(
                    "|| ÿßŸÑÿ≥ÿßÿ®ŸÇ ||", data="{}_prev({})".format(prefix, modulo_page)
                ),
                custom.Button.inline("ÿßÿ∫ŸÑÿßŸÇ", data="close"),
                custom.Button.inline(
                    "|| ÿßŸÑÿ™ÿßŸÑŸä ||", data="{}_next({})".format(prefix, modulo_page)
                ),
            )
        ]
    return pairs


async def userinfo(event):
    tarzt = await event.client(GetFullUserRequest(event.query.user_id))
    first_name = html.escape(tarzt.user.first_name)
    if first_name is not None:
        first_name = first_name.replace("\u2060", "")
    return first_name
